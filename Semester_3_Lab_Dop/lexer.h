#pragma once

#include <string>
#include "token.h"

/*
 * Класс Lexer реализует лексический анализатор языка ProbabilityScript.
 *
 * Лексер преобразует входную строку исходного кода в поток токенов (Token),
 * которые затем используются синтаксическим анализатором (Parser).
 *
 * Использование:
 *   Lexer lex(source);
 *   Token t = lex.NextToken();
 */
class Lexer {
public:
    /*
     * Конструктор лексера.
     *
     * @param src исходный текст программы
     */
    explicit Lexer(const std::string& src);

    /*
     * Считать и вернуть следующий токен из входного потока.
     *
     * При достижении конца входных данных возвращает токен EndOfFile.
     */
    Token NextToken();

private:
    // ================== Состояние лексера ==================

    std::string source;   // Полный текст исходной программы
    std::size_t pos;      // Текущая позиция в строке source
    int line;             // Текущий номер строки (начиная с 1)
    int column;           // Текущий номер столбца (начиная с 1)

    // ================== Вспомогательные методы ==================

    /*
     * Посмотреть текущий символ без продвижения позиции.
     * Возвращает '\0', если достигнут конец входа.
     */
    char Peek() const;

    /*
     * Посмотреть следующий символ (pos + 1) без продвижения позиции.
     * Возвращает '\0', если символа не существует.
     */
    char PeekNext() const;

    /*
     * Считать текущий символ и сдвинуть позицию вперёд.
     * Обновляет счётчики строки и столбца.
     */
    char Get();

    /*
     * Пропустить все пробельные символы:
     * пробелы, табуляции, переводы строк.
     */
    void SkipWhitespace();

    /*
     * Пропустить однострочный комментарий вида // ...
     * Если текущая позиция не указывает на комментарий — ничего не делает.
     */
    void SkipCommentIfAny();

    // ================== Лексемы ==================

    /*
     * Лексический разбор числового литерала.
     *
     * @param startLine строка начала токена
     * @param startCol  столбец начала токена
     */
    Token LexNumber(int startLine, int startCol);

    /*
     * Лексический разбор идентификатора или ключевого слова.
     *
     * В зависимости от содержимого возвращает либо Identifier,
     * либо соответствующий keyword-токен.
     */
    Token LexIdentifierOrKeyword(int startLine, int startCol);

    /*
     * Лексический разбор строкового литерала в двойных кавычках.
     */
    Token LexStringLiteral(int startLine, int startCol);

    // ================== Проверки символов ==================

    /*
     * Проверка, может ли символ быть первым в идентификаторе.
     */
    static bool IsIdentStart(char c);

    /*
     * Проверка, может ли символ входить в тело идентификатора.
     */
    static bool IsIdentChar(char c);
};